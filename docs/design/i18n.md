# 多言語対応設計

## 概要

i18nextライブラリを使用した日本語・英語の多言語対応。
将来的な言語追加を想定した拡張可能な設計。

## 使用ライブラリ

```bash
pnpm add i18next react-i18next
```

## ディレクトリ構成

```
src/
└── locales/
    ├── ja/
    │   └── translation.json
    ├── en/
    │   └── translation.json
    └── index.ts
```

## i18n設定

### 初期化ファイル

```typescript
// src/locales/index.ts
import i18n from 'i18next';
import { initReactI18next } from 'react-i18next';
import ja from './ja/translation.json';
import en from './en/translation.json';

// 翻訳リソース
const resources = {
  ja: {
    translation: ja,
  },
  en: {
    translation: en,
  },
};

i18n
  .use(initReactI18next)
  .init({
    resources,
    lng: 'ja', // デフォルト言語
    fallbackLng: 'ja', // フォールバック言語
    interpolation: {
      escapeValue: false, // Reactは自動でエスケープするためfalse
    },
  });

export default i18n;
```

### Appでの読み込み

```typescript
// src/main.tsx
import React from 'react';
import ReactDOM from 'react-dom/client';
import './locales'; // i18nを初期化
import App from './App';
import './index.css';

ReactDOM.createRoot(document.getElementById('root')!).render(
  <React.StrictMode>
    <App />
  </React.StrictMode>
);
```

## 翻訳ファイル

### 日本語 (ja/translation.json)

```json
{
  "app": {
    "title": "ToDoアプリ"
  },
  "nav": {
    "tasks": "タスク",
    "statistics": "統計"
  },
  "categories": {
    "title": "カテゴリ",
    "add": "カテゴリ追加",
    "edit": "カテゴリ編集",
    "delete": "カテゴリ削除",
    "confirmDelete": "このカテゴリを削除しますか？関連するタスクも削除されます。",
    "name": "カテゴリ名",
    "color": "カラー"
  },
  "tasks": {
    "title": "タスク一覧",
    "add": "追加",
    "edit": "編集",
    "delete": "削除",
    "confirmDelete": "このタスクを削除しますか？",
    "addPlaceholder": "新しいタスクを入力...",
    "empty": "タスクがありません",
    "completed": "完了済み",
    "incomplete": "未完了"
  },
  "filter": {
    "all": "すべて",
    "active": "未完了",
    "completed": "完了済み"
  },
  "reminders": {
    "title": "リマインダー",
    "add": "リマインダー追加",
    "edit": "リマインダー編集",
    "delete": "リマインダー削除",
    "time": "時刻",
    "frequency": "頻度",
    "enabled": "有効",
    "disabled": "無効",
    "frequencies": {
      "daily": "毎日",
      "weekly": "毎週",
      "monthly": "毎月",
      "custom": "カスタム"
    },
    "customDays": "曜日選択",
    "days": {
      "monday": "月",
      "tuesday": "火",
      "wednesday": "水",
      "thursday": "木",
      "friday": "金",
      "saturday": "土",
      "sunday": "日"
    }
  },
  "stats": {
    "title": "統計",
    "daily": "今日",
    "weekly": "今週",
    "monthly": "今月",
    "dailyChart": "日別完了数",
    "weeklyChart": "週別完了数",
    "monthlyChart": "月別完了数",
    "byCategory": "カテゴリ別統計",
    "noData": "データがありません",
    "completionRate": "完了率",
    "totalTasks": "総タスク数",
    "completedTasks": "完了タスク数"
  },
  "settings": {
    "title": "設定",
    "theme": "テーマ",
    "light": "ライト",
    "dark": "ダーク",
    "language": "言語",
    "notifications": "通知",
    "notificationsDesc": "リマインダー通知を受け取る",
    "backgroundMode": "バックグラウンド動作",
    "backgroundModeDesc": "アプリを閉じてもバックグラウンドで動作"
  },
  "common": {
    "save": "保存",
    "cancel": "キャンセル",
    "ok": "OK",
    "loading": "読み込み中...",
    "error": "エラーが発生しました",
    "success": "成功しました",
    "confirm": "確認",
    "close": "閉じる"
  },
  "errors": {
    "required": "必須項目です",
    "invalidTime": "無効な時刻形式です",
    "networkError": "ネットワークエラーが発生しました",
    "databaseError": "データベースエラーが発生しました"
  },
  "notifications": {
    "taskReminder": "タスクのリマインダー",
    "taskDue": "{{title}}の時間です"
  }
}
```

### 英語 (en/translation.json)

```json
{
  "app": {
    "title": "ToDo App"
  },
  "nav": {
    "tasks": "Tasks",
    "statistics": "Statistics"
  },
  "categories": {
    "title": "Categories",
    "add": "Add Category",
    "edit": "Edit Category",
    "delete": "Delete Category",
    "confirmDelete": "Are you sure you want to delete this category? Related tasks will also be deleted.",
    "name": "Category Name",
    "color": "Color"
  },
  "tasks": {
    "title": "Task List",
    "add": "Add",
    "edit": "Edit",
    "delete": "Delete",
    "confirmDelete": "Are you sure you want to delete this task?",
    "addPlaceholder": "Enter a new task...",
    "empty": "No tasks",
    "completed": "Completed",
    "incomplete": "Incomplete"
  },
  "filter": {
    "all": "All",
    "active": "Active",
    "completed": "Completed"
  },
  "reminders": {
    "title": "Reminders",
    "add": "Add Reminder",
    "edit": "Edit Reminder",
    "delete": "Delete Reminder",
    "time": "Time",
    "frequency": "Frequency",
    "enabled": "Enabled",
    "disabled": "Disabled",
    "frequencies": {
      "daily": "Daily",
      "weekly": "Weekly",
      "monthly": "Monthly",
      "custom": "Custom"
    },
    "customDays": "Select Days",
    "days": {
      "monday": "Mon",
      "tuesday": "Tue",
      "wednesday": "Wed",
      "thursday": "Thu",
      "friday": "Fri",
      "saturday": "Sat",
      "sunday": "Sun"
    }
  },
  "stats": {
    "title": "Statistics",
    "daily": "Today",
    "weekly": "This Week",
    "monthly": "This Month",
    "dailyChart": "Daily Completions",
    "weeklyChart": "Weekly Completions",
    "monthlyChart": "Monthly Completions",
    "byCategory": "Statistics by Category",
    "noData": "No data available",
    "completionRate": "Completion Rate",
    "totalTasks": "Total Tasks",
    "completedTasks": "Completed Tasks"
  },
  "settings": {
    "title": "Settings",
    "theme": "Theme",
    "light": "Light",
    "dark": "Dark",
    "language": "Language",
    "notifications": "Notifications",
    "notificationsDesc": "Receive reminder notifications",
    "backgroundMode": "Background Mode",
    "backgroundModeDesc": "Keep running in background when app is closed"
  },
  "common": {
    "save": "Save",
    "cancel": "Cancel",
    "ok": "OK",
    "loading": "Loading...",
    "error": "An error occurred",
    "success": "Success",
    "confirm": "Confirm",
    "close": "Close"
  },
  "errors": {
    "required": "This field is required",
    "invalidTime": "Invalid time format",
    "networkError": "Network error occurred",
    "databaseError": "Database error occurred"
  },
  "notifications": {
    "taskReminder": "Task Reminder",
    "taskDue": "Time for {{title}}"
  }
}
```

## 使用方法

### コンポーネント内での使用

```typescript
import { useTranslation } from 'react-i18next';

const MyComponent: FC = () => {
  const { t, i18n } = useTranslation();

  // 基本的な翻訳
  const title = t('app.title');

  // 変数を含む翻訳
  const message = t('notifications.taskDue', { title: 'プロジェクト資料作成' });

  // 言語切り替え
  const changeLanguage = (lang: string) => {
    i18n.changeLanguage(lang);
  };

  return (
    <div>
      <h1>{t('app.title')}</h1>
      <button onClick={() => changeLanguage('en')}>English</button>
      <button onClick={() => changeLanguage('ja')}>日本語</button>
    </div>
  );
};
```

### 複数形の扱い

```json
{
  "tasks": {
    "count": "{{count}}個のタスク",
    "count_plural": "{{count}}個のタスク"
  }
}
```

```typescript
// 使用例
t('tasks.count', { count: 1 });  // "1個のタスク"
t('tasks.count', { count: 5 });  // "5個のタスク"
```

### ネストされたキーへのアクセス

```typescript
// ドット記法
t('reminders.frequencies.daily'); // "毎日"

// オブジェクトとして取得
const frequencies = t('reminders.frequencies', { returnObjects: true });
// { daily: '毎日', weekly: '毎週', ... }
```

## 設定との連携

### SettingsContextと連携

```typescript
// src/contexts/SettingsContext.tsx
import { useTranslation } from 'react-i18next';

const SettingsProvider: FC<{ children: ReactNode }> = ({ children }) => {
  const { i18n } = useTranslation();
  const [state, dispatch] = useReducer(settingsReducer, initialState);

  useEffect(() => {
    // 設定読み込み時に言語を適用
    i18n.changeLanguage(state.language);
  }, [state.language, i18n]);

  const setLanguage = (language: 'ja' | 'en') => {
    dispatch({ type: 'SET_LANGUAGE', payload: language });
    i18n.changeLanguage(language);
  };

  // ...
};
```

## 型安全な翻訳キー

TypeScriptで翻訳キーを型安全にする:

```typescript
// src/types/i18n.d.ts
import 'react-i18next';
import ja from '../locales/ja/translation.json';

declare module 'react-i18next' {
  interface CustomTypeOptions {
    defaultNS: 'translation';
    resources: {
      translation: typeof ja;
    };
  }
}
```

これにより、`t()`関数の引数が自動補完されます:

```typescript
t('app.title'); // OK
t('app.invalid'); // TypeScriptエラー
```

## 日付・時刻のフォーマット

```typescript
// 日付フォーマット
const formatDate = (date: Date, locale: string) => {
  return new Intl.DateTimeFormat(locale === 'ja' ? 'ja-JP' : 'en-US').format(date);
};

// 時刻フォーマット
const formatTime = (time: string, locale: string) => {
  const [hours, minutes] = time.split(':');
  const date = new Date();
  date.setHours(parseInt(hours), parseInt(minutes));
  return new Intl.DateTimeFormat(locale === 'ja' ? 'ja-JP' : 'en-US', {
    hour: '2-digit',
    minute: '2-digit',
  }).format(date);
};
```

## 新しい言語の追加手順

将来的に新言語を追加する場合:

1. **翻訳ファイルを作成**
   ```
   src/locales/fr/translation.json
   ```

2. **i18n設定に追加**
   ```typescript
   import fr from './fr/translation.json';

   const resources = {
     ja: { translation: ja },
     en: { translation: en },
     fr: { translation: fr }, // 追加
   };
   ```

3. **型定義を更新** (必要に応じて)

4. **設定画面に選択肢を追加**
   ```typescript
   <option value="fr">Français</option>
   ```

## ベストプラクティス

### 1. 翻訳キーの命名規則
- 階層構造を使用（`category.subcategory.key`）
- 具体的で意味のある名前を使う
- 動詞形式を統一（例: "add", "edit", "delete"）

### 2. デフォルト値の提供
```typescript
t('unknown.key', { defaultValue: 'フォールバックテキスト' });
```

### 3. コンテキストの活用
```json
{
  "task": "タスク",
  "task_context": "作業",
  "task_context_work": "業務"
}
```

### 4. 変数の使用
```json
{
  "welcome": "ようこそ、{{name}}さん"
}
```

```typescript
t('welcome', { name: 'ユーザー' }); // "ようこそ、ユーザーさん"
```

## Tauriバックエンドとの連携

Rust側でも多言語対応が必要な場合（通知メッセージなど）:

```rust
// src-tauri/src/i18n.rs
pub fn get_notification_message(lang: &str, task_title: &str) -> String {
    match lang {
        "ja" => format!("{}の時間です", task_title),
        "en" => format!("Time for {}", task_title),
        _ => format!("Time for {}", task_title),
    }
}
```

```rust
// 使用例
use tauri_plugin_notification::NotificationExt;

let message = get_notification_message(&settings.language, &task.title);
app.notification()
    .builder()
    .title("Task Reminder")
    .body(&message)
    .show()?;
```

## テスト

翻訳のテスト例:

```typescript
// __tests__/i18n.test.ts
import i18n from '../locales';

describe('i18n', () => {
  it('should translate Japanese correctly', async () => {
    await i18n.changeLanguage('ja');
    expect(i18n.t('app.title')).toBe('ToDoアプリ');
  });

  it('should translate English correctly', async () => {
    await i18n.changeLanguage('en');
    expect(i18n.t('app.title')).toBe('ToDo App');
  });

  it('should handle variables', async () => {
    await i18n.changeLanguage('ja');
    expect(i18n.t('notifications.taskDue', { title: 'テスト' }))
      .toBe('テストの時間です');
  });
});
```

## パフォーマンス最適化

### 遅延読み込み

大規模アプリの場合、翻訳ファイルを遅延読み込み:

```typescript
import i18n from 'i18next';
import Backend from 'i18next-http-backend';

i18n
  .use(Backend)
  .use(initReactI18next)
  .init({
    backend: {
      loadPath: '/locales/{{lng}}/{{ns}}.json',
    },
    // ...
  });
```

ただし、Tauriアプリではすべてバンドルするため基本的には不要。
